#!/bin/bash

set -eu

RUN_DIR=/var/vcap/sys/run/dex_worker
LOG_DIR=/var/vcap/sys/log/dex_worker
TMP_DIR=/var/vcap/sys/tmp/dex_worker
STORE_DIR=/var/vcap/store/dex_worker
mkdir -p ${RUN_DIR} ${LOG_DIR} ${TMP_DIR} ${STORE_DIR}

PIDFILE=${RUN_DIR}/dex_worker.pid

source /var/vcap/packages/dex/common/utils.sh

export PATH=${PATH}:/var/vcap/packages/dex/bin

case $1 in
  start)
    pid_guard ${PIDFILE} "dex_worker"
    echo $$ > ${PIDFILE}

    exec dex-worker \
      <% if p('dex.worker.no_db') %> \
      -no-db \
      -clients="/var/vcap/jobs/dex_worker/config/clients.json" \
      -connectors="/var/vcap/jobs/dex_worker/config/connectors.json" \
      -users="/var/vcap/jobs/dex_worker/config/users.json" \
      <% else %> \
      -db-url="<%= p('dex.worker.db_url') %>" \
      <% end %> \
      <% if p('dex.worker.api_use_client_credentials') %> \
      -api-use-client-credentials \
      <% end %> \
      <% if_p('dex.worker.db_max_idle_conns') do |db_max_idle_conns| %> \
      -db-max-idle-conns=<%= db_max_idle_conns %> \
      <% end %> \
      <% if_p('dex.worker.db_max_open_conns') do |db_max_open_conns| %> \
      -db-max-open-conns=<%= db_max_open_conns %> \
      <% end %> \
      -email-cfg="/var/vcap/jobs/dex_worker/config/emailer.json" \
      -email-templates="/var/vcap/packages/dex/static/email" \
      <% if p('dex.worker.enable_automatic_registration') %> \
      -enable-automatic-registration \
      <% end %> \
      <% if p('dex.worker.enable_client_registration') %> \
      -enable-client-registration \
      <% end %> \
      <% if p('dex.worker.enable_registration') %> \
      -enable-registration \
      <% end %> \
      -html-assets="/var/vcap/packages/dex/static/html" \
      <% if_p('dex.worker.issuer_host') do |issuer_host| %> \
      -issuer="https://<%= issuer_host %>:<%= p('dex.worker.port') %>" \
      <% end.else do %> \
      -issuer="https://<%= spec.address %>:<%= p('dex.worker.port') %>" \
      <% end %> \
      <% if_p('dex.worker.issuer_logo_url') do |issuer_logo_url| %> \
      -issuer-logo-url="<%= issuer_logo_url %>" \
      <% end %> \
      <% if_p('dex.worker.issuer_name') do |issuer_name| %> \
      -issuer-name="<%= issuer_name %>" \
      <% end %> \
      -key-secrets="<%= p('dex.worker.key_secrets') %>" \
      -listen="https://<%= spec.address %>:<%= p('dex.worker.port') %>" \
      <% if p('dex.worker.log_debug') %> \
      -log-debug \
      <% end %> \
      <% if p('dex.worker.log_timestamps') %> \
      -log-timestamps \
      <% end %> \
      <% if_p('dex.worker.tls_cert') do %> \
      -tls-cert-file="/var/vcap/jobs/dex_worker/config/tls_cert.pem" \
      <% end %> \
      <% if_p('dex.worker.tls_key') do %> \
      -tls-key-file="/var/vcap/jobs/dex_worker/config/tls_key.pem" \
      <% end %> \
      >>  ${LOG_DIR}/dex_worker.stdout.log \
      2>> ${LOG_DIR}/dex_worker.stderr.log
    ;;

  stop)
    kill_and_wait ${PIDFILE}
    ;;

  *)
    echo "Usage: $0 {start|stop}"
    exit 1
  ;;

esac
exit 0
