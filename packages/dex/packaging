#!/bin/bash

set -eux

# Copy common utils
mkdir -p ${BOSH_INSTALL_TARGET}/common
cp -a ${BOSH_COMPILE_TARGET}/common/* ${BOSH_INSTALL_TARGET}/common

# Build dex package
export GOROOT=$(readlink -nf /var/vcap/packages/golang)
export PATH=${GOROOT}/bin:${PATH}

PACKAGE_NAME=github.com/coreos/dex
mkdir -p ${BOSH_INSTALL_TARGET}/src/${PACKAGE_NAME}
cp -a ${BOSH_COMPILE_TARGET}/${PACKAGE_NAME}/* ${BOSH_INSTALL_TARGET}/src/${PACKAGE_NAME}
export GOPATH=${BOSH_INSTALL_TARGET}

for DEXCMD in "dex-worker" "dexctl" "dex-overlord"; do
  go install ${PACKAGE_NAME}/cmd/${DEXCMD}
done

mkdir -p ${BOSH_INSTALL_TARGET}/static
cp -a ${BOSH_COMPILE_TARGET}/${PACKAGE_NAME}/static/* ${BOSH_INSTALL_TARGET}/static

rm -rf ${BOSH_INSTALL_TARGET}/pkg ${BOSH_INSTALL_TARGET}/src
